# ModSysLab5
### Цель работы и постановка задачи
Разработать программу, которая будет считывать временные ряды отклика y и факторов Х из текстового файла и выполнять следующие операции:  
  
- Оценка параметров линейной многофакторной модели (ЛМФМ).
- Отбор значимых факторов (решение об отсеве факторов, возврате к повторной процедуре отсева и т.д. принимает пользователь)  
  - по статистической значимости (критерий выбирается разработчиком, но уровень значимости - пользователем); 
  - по коэффициенту корреляции - связь между факторами (между собой);
  - по коэффициенту корреляции - связь между факторами и откликом;
  - оценка целесообразности исключения факторов.
- Оценка адекватности модели:
  - оценка коэффициента детерминации на статистическую значимость (F - статистика) и сообщение: адекватна модель или нет;
  - вычисление ошибки (E = 1/n * sum ((yi-yit)/yit) или RMSE (см. https://forecast.nanoquant.ru/metric/rmse.htm?ysclid=lq13nco4o5817601598);
  - вычисление и вывод пользователю специальных показателей.
- Выполнения предсказания с помощью построенной модели на основе ввода значений факторов (новые факторы для предсказания можно внести в отдельный файл).
  По возможности текстовый вывод на консоль можно сохранить в выходной текстовый файл. 

### Краткое описание процедуры построения и оценки ЛМФМ
#### 1. Оценка параметров линейной многофакторной модели (ЛМФМ)
```
def linear_regression(X, y):
    X_train = sm.add_constant(X)  # Добавляем константу для модели
    model = sm.OLS(y, X_train).fit()
    return model
```
Линейная многофакторная модель описывает зависимость
зависимой переменной y от нескольких независимых переменных = факторов
```
y=b0+b1*X1+b2*X2+...+bn*Xn+e
```
Где:  
**b0** — свободный член (интерцепт)  
**b1, b2, ..., bn** — коэффициенты модели для соответствующих факторов  
**e** — случайная ошибка.

```
X_train = sm.add_constant(X)
```
Эта функция добавляет столбец единиц к матрице факторов X.
Это необходимо для оценки интерцепта, чтобы "нормализовать" значения.
  
**Результат выполнения**
```
OLS Regression Results                            
==============================================================================
Dep. Variable:        Calories_Burned   R-squared:                       0.979
Model:                            OLS   Adj. R-squared:                  0.979
Method:                 Least Squares   F-statistic:                     3484.
Date:                Thu, 24 Oct 2024   Prob (F-statistic):               0.00
Time:                        15:16:27   Log-Likelihood:                -4951.2
No. Observations:                 973   AIC:                             9930.
Df Residuals:                     959   BIC:                             9999.
Df Model:                          13                                         
Covariance Type:            nonrobust           
=================================================================================================
                                    coef    std err          t      P>|t|      [0.025      0.975]
-------------------------------------------------------------------------------------------------
const                          -949.5433     88.622    -10.715      0.000   -1123.458    -775.629
Age                              -3.4300      0.105    -32.676      0.000      -3.636      -3.224
Gender                          -82.3638      4.571    -18.018      0.000     -91.335     -73.393
Weight (kg)                      -1.1696      0.511     -2.290      0.022      -2.172      -0.167
Height (m)                      117.8974     47.011      2.508      0.012      25.642     210.153
Max_BPM                           0.0352      0.111      0.318      0.750      -0.182       0.252
Avg_BPM                           6.2407      0.089     70.284      0.000       6.066       6.415
Resting_BPM                       0.4006      0.174      2.304      0.021       0.059       0.742
Session_Duration (hours)        714.2807      5.901    121.037      0.000     702.700     725.862
Fat_Percentage                   -0.4386      0.336     -1.306      0.192      -1.098       0.221
Water_Intake (liters)            -1.1948      3.248     -0.368      0.713      -7.569       5.179
Workout_Frequency (days/week)     1.8462      2.549      0.724      0.469      -3.157       6.849
Experience_Level                 -2.8981      3.979     -0.728      0.467     -10.706       4.910
BMI                               3.9077      1.554      2.515      0.012       0.859       6.957
==============================================================================
Omnibus:                       47.835   Durbin-Watson:                   2.122
Prob(Omnibus):                  0.000   Jarque-Bera (JB):               91.426
Skew:                           0.336   Prob(JB):                     1.40e-20
Kurtosis:                       4.343   Cond. No.                     2.00e+04
==============================================================================                              
```
**Где:**   
**coef**: Значения коэффициентов (b).  
**const**: Значение интерцепта (b0).  
**Age, Gender ....** : Коэффициенты для соответствующих факторов.  
**std err**: Стандартная ошибка оценки коэффициента.  
**t**: t-статистика для проверки гипотезы о значимости коэффициента.  
**P>|t|**: p-значение для проверки гипотезы.  
**[ 0.025 0.975]**: 95% доверительный интервал для коэффициента.  

#### 2. Отбор значимых факторов 
2.1. Отбор значимых факторов по статистической значимости
```
def select_significant_factors(model, alpha):
    summary = model.summary2().tables[1]
    significant_factors = summary[summary['P>|t|'] < alpha].index.tolist()
    if "const" in significant_factors:
        significant_factors.remove("const")
    return significant_factors
```
2.2. Отбор по коэффициенту корреляции - связь между факторами
```
def check_multicollinearity(X, threshold=0.8):
    corr_matrix = X.corr().abs()
    upper = corr_matrix.where(np.triu(np.ones(corr_matrix.shape), k=1).astype(bool))
    high_corr = [
        (column, row)
        for column in upper.columns
        for row in upper.index
        if upper.loc[row, column] > threshold
    ]
    return high_corr
```
  
2.3. Отбор по коэффициенту корреляции - связь между факторами и откликом
```
def correlation_analysis(X, y):
    correlations = {}
    for col in X.columns:
        corr, _ = pearsonr(X[col], y)
        correlations[col] = corr
    return correlations
```
  
##### Критерии для Исключения Факторов
- **Статистическая Значимость (p-значение):**  
Показывает, насколько фактор важен для модели.  
Если p-значение фактора выше выбранного уровня значимости (например, 0.05), фактор считается статистически
незначимым и может быть исключен.
- **Мультиколлинеарность (Корреляция между Факторами)**:  
Означает сильную взаимосвязь между двумя или более факторами. 
Используя корреляционную матрицу. Если корреляция между
факторами превышает порог (например, 0.8), один из них следует удалить, чтобы избежать
- **Корреляция с Откликом**:
Показывает, насколько сильно фактор связан с зависимой переменной.  
Факторы с низкой корреляцией с откликом могут иметь малое влияние на
модель и быть кандидатами на исключение.

#### 3. Оценка адекватности модели:
3.1. Оценка коэффициента детерминации на статистическую значимость (F - статистика) и сообщение: адекватна модель или нет:
```
# Оценка F-статистики и адекватности модели
f_stat = model.fvalue
print(f"F-статистика: {f_stat}")

f_pval = model.f_pvalue

if f_pval < alpha:
    print("Модель адекватна")
else:
    print("Модель неадекватна")
```

3.2. Вычислене RMSE:
```
def compute_rmse(y_true, y_pred):
    return np.sqrt(mean_squared_error(y_true, y_pred))
```

3.3. вычисление и вывод пользователю специальных данных:
```
r2 = r2_score(y, y_pred)
rmse = compute_rmse(y, y_pred)
print(f"Коэффициент детерминации (R^2) на тестовых данных: {r2}")
print(f"RMSE на тестовых данных: {rmse}")

# Оценка F-статистики и адекватности модели
f_stat = model.fvalue
print(f"F-статистика: {f_stat}")

f_pval = model.f_pvalue

if f_pval < alpha:
    print("Модель адекватна")
else:
    print("Модель неадекватна")
```

#### 4. Выполнения предсказания с помощью построенной модели на основе ввода значений факторов (новые факторы для предсказания можно внести в отдельный файл).
```
def predict_new(model, new_data_path):
    """
    Предсказание новых значений отклика на основе введённых факторов.
    """
    try:
        new_data = pd.read_csv(new_data_path, sep=None, engine="python")
        predictions = model.predict(new_data)
        return predictions
    except Exception as e:
        if len(new_data_path) >0:
            print(f"Ошибка при чтении файла с новыми данными: {e}")
        sys.exit(1)
```